# ADR-0002: 未確定参照（Skipped refs）の決定ログ

- Date: 2026-01-26
- Status: Deferred（pro_testは仮置きのため後回し）
- Owner: JPBA-system maintainers
- Related:
  - docs/db/refs_skipped.md（未確定参照の一覧）
  - docs/db/data_dictionary.md（DB設計の正本）
  - generate_er_from_dictionary.php（ER.dbml 自動生成）

---

## 背景 / Context

JPBA-system では **docs/db/data_dictionary.md を正本**として DB スキーマを整備し、
`generate_er_from_dictionary.php` により `docs/db/ER.dbml` を自動生成する運用を採用している。

この運用の中で、辞書上で **外部キー参照先が確定できないカラム**（参照先テーブルが未定義 / 命名未確定 / 正規化方針未決定 など）が存在する場合、
自動生成時に参照を確定できないため、当該参照は `docs/db/refs_skipped.md` に記録し、ER 生成では「参照なし」として扱う。

本 ADR は、`docs/db/refs_skipped.md` に記録された **未確定参照を“どう確定するか”を決めていくための決定ログ**である。

---

## 現在の Skipped refs（2026-01-23 生成分）

`docs/db/refs_skipped.md` より：

- `pro_test.record_type_id`

---

## 問題 / Problem

`pro_test.record_type_id` が **どのマスタ（または列挙）を参照するべきか未確定**のため、
データ辞書（正本）に参照定義を確定できず、ER 自動生成でも参照を張れない状態になっている。

---

## 決定したいこと / Decision to Make

`pro_test.record_type_id` の「意味」と「参照先」を確定し、以下を完了させる。

1. `docs/db/data_dictionary.md` に参照定義を追記（正本更新）
2. 必要なマスタテーブル/制約を migrations で実装
3. ER 自動生成後、`docs/db/refs_skipped.md` から当該項目が消える状態にする（=確定）

---

## 選択肢 / Options

### Option A: 専用マスタを新設する（推奨候補）
- 例：`pro_test_record_types`（名称はプロジェクト規約に合わせて確定）
- `pro_test.record_type_id` は上記マスタへの FK
- 利点：意味が明確、拡張（種別追加）に強い、参照整合性が担保できる
- 欠点：マスタ管理が増える（初期データ投入が必要）

### Option B: 既存の汎用マスタがある前提でそこへ寄せる
- 例：既に `record_types` / `master_record_types` のような汎用が存在する場合
- 利点：マスタ増殖を防げる
- 欠点：汎用マスタのスコープが曖昧だと、将来の保守で意味が崩れる

### Option C: FK を張らず、列挙（ENUM 相当）で表現する
- PostgreSQL の ENUM、または smallint + CHECK 制約
- 利点：シンプルで参照テーブル不要
- 欠点：アプリ側・DB側で値管理が分散しやすい、運用変更に弱い

### Option D: カラム自体を廃止/置換する
- record_type が不要、または別カラムに統合できる場合
- 利点：設計が整理される
- 欠点：既存データ移行の検討が必要

---

## 暫定方針 / Interim Policy（決定までのルール）

- 決定ができるまで `pro_test.record_type_id` は **refs_skipped に残す**
- ER 自動生成では **参照なし**として扱う（現在の運用通り）
- 正本（data_dictionary.md）へ **推測で参照を追加しない**

---

## 決定プロセス / How to Decide（最短手順）

以下のどれかで「record_type_id の実体」を特定する。

1. **リポジトリ全体検索**で利用箇所を確認  
   - `record_type_id` / `record_type` / `pro_test` で検索し、どの値が入り得るかを見る
2. **旧DB/SQLダンプ**に record_type 相当のマスタが存在するか確認  
   - 該当テーブルや定義（FK/INDEX/コメント）を確認
3. **画面・業務要件**から「種別」が何を表すか確定  
   - 例：試験種別、申請種別、区分（男女/カテゴリではない）など

> この ADR の Status は、参照先と方針が確定した時点で `Accepted` に更新する。

---

## 決定 / Decision

- Status が Proposed のため **未決定（TBD）**
- 決定時にここへ明記し、併せて data_dictionary / migrations を更新する

---

## 決定後に必ずやること / Follow-ups (Required)

決定が固まったら、**必ずセットで**実施する：

1. `docs/db/data_dictionary.md` を更新（参照先・FK・nullable・意味を明確化）
2. migrations を更新（必要ならマスタ新設 + FK + index + seed 方針）
3. `generate_er_from_dictionary.php` を実行し、`docs/db/ER.dbml` を更新（手編集しない）
4. `docs/db/refs_skipped.md` から `pro_test.record_type_id` が消えることを確認

---

## 付記 / Notes

- refs_skipped は「放置リスト」ではなく、**必ず ADR と紐づけて潰していくためのキュー**として扱う。
- 推測で参照を決め打ちせず、根拠（旧DB、コード、要件）に基づいて確定する。
